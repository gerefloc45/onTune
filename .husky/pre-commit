#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook per onTune Bot
# Esegue controlli di qualità del codice prima di ogni commit

echo "🔍 Eseguendo controlli pre-commit..."

# 1. Lint del codice
echo "📝 Controllo linting..."
npm run lint
if [ $? -ne 0 ]; then
  echo "❌ Errori di linting trovati. Correggi gli errori prima di committare."
  echo "💡 Suggerimento: esegui 'npm run lint:fix' per correzioni automatiche"
  exit 1
fi

# 2. Controllo formattazione
echo "🎨 Controllo formattazione..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "❌ Problemi di formattazione trovati. Formatta il codice prima di committare."
  echo "💡 Suggerimento: esegui 'npm run format' per formattare automaticamente"
  exit 1
fi

# 3. Test unitari veloci
echo "🧪 Eseguendo test unitari..."
npm run test:unit
if [ $? -ne 0 ]; then
  echo "❌ Test unitari falliti. Correggi i test prima di committare."
  exit 1
fi

# 4. Controllo configurazione
echo "⚙️ Validando configurazione..."
node -e "
try {
  require('./src/utils/config');
  console.log('✅ Configurazione valida');
} catch (error) {
  console.error('❌ Errore nella configurazione:', error.message);
  process.exit(1);
}
" 2>/dev/null

if [ $? -ne 0 ]; then
  echo "❌ Configurazione non valida. Controlla i file di configurazione."
  exit 1
fi

# 5. Controllo dipendenze vulnerabili
echo "🔒 Controllo vulnerabilità..."
npm audit --audit-level=high --production
if [ $? -ne 0 ]; then
  echo "⚠️ Vulnerabilità di sicurezza trovate. Considera di aggiornarle."
  echo "💡 Suggerimento: esegui 'npm audit fix' per correzioni automatiche"
  # Non blocchiamo il commit per vulnerabilità, ma avvisiamo
fi

# 6. Controllo dimensioni file
echo "📏 Controllo dimensioni file..."
find . -name "*.js" -not -path "./node_modules/*" -not -path "./coverage/*" -not -path "./logs/*" -size +100k -exec echo "⚠️ File grande trovato: {}" \;

# 7. Controllo per segreti/token
echo "🔐 Controllo per segreti esposti..."
if grep -r -i --include="*.js" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git "token\|password\|secret\|key" . | grep -v "mock\|test\|example\|placeholder"; then
  echo "❌ Possibili segreti trovati nel codice. Rimuovi token/password prima di committare."
  echo "💡 Usa variabili d'ambiente o file .env (non committati) per i segreti"
  exit 1
fi

# 8. Controllo TODO/FIXME
echo "📋 Controllo TODO/FIXME..."
todo_count=$(grep -r -i --include="*.js" --exclude-dir=node_modules "TODO\|FIXME\|XXX" . | wc -l)
if [ $todo_count -gt 0 ]; then
  echo "📝 Trovati $todo_count TODO/FIXME nel codice"
  echo "💡 Considera di completare o documentare questi elementi"
fi

echo "✅ Tutti i controlli pre-commit completati con successo!"
echo "🚀 Procedendo con il commit..."