#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook per onTune Bot
# Esegue test completi e controlli di sicurezza prima del push

echo "ğŸš€ Eseguendo controlli pre-push..."

# 1. Test completi con coverage
echo "ğŸ§ª Eseguendo suite di test completa..."
npm run test:ci
if [ $? -ne 0 ]; then
  echo "âŒ Test falliti. Non Ã¨ possibile pushare con test che falliscono."
  exit 1
fi

# 2. Controllo coverage minima
echo "ğŸ“Š Controllo coverage..."
if [ -f "coverage/lcov.info" ]; then
  # Estrai la percentuale di coverage dalle linee
  coverage=$(grep -o "LF:[0-9]*" coverage/lcov.info | awk -F: '{sum+=$2} END {print sum}')
  covered=$(grep -o "LH:[0-9]*" coverage/lcov.info | awk -F: '{sum+=$2} END {print sum}')
  
  if [ $coverage -gt 0 ]; then
    percentage=$((covered * 100 / coverage))
    echo "ğŸ“ˆ Coverage attuale: ${percentage}%"
    
    if [ $percentage -lt 70 ]; then
      echo "âŒ Coverage troppo bassa (${percentage}% < 70%). Aggiungi piÃ¹ test."
      exit 1
    fi
  fi
else
  echo "âš ï¸ File di coverage non trovato. Assicurati che i test generino coverage."
fi

# 3. Test di integrazione
echo "ğŸ”— Eseguendo test di integrazione..."
npm run test:integration
if [ $? -ne 0 ]; then
  echo "âŒ Test di integrazione falliti."
  exit 1
fi

# 4. Audit di sicurezza completo
echo "ğŸ”’ Audit di sicurezza completo..."
npm audit --audit-level=moderate
if [ $? -ne 0 ]; then
  echo "âŒ VulnerabilitÃ  di sicurezza critiche trovate. Risolvi prima di pushare."
  echo "ğŸ’¡ Esegui 'npm audit fix' per correzioni automatiche"
  exit 1
fi

# 5. Controllo dipendenze obsolete
echo "ğŸ“¦ Controllo dipendenze obsolete..."
npm outdated --depth=0
if [ $? -eq 1 ]; then
  echo "âš ï¸ Alcune dipendenze sono obsolete. Considera di aggiornarle."
  echo "ğŸ’¡ Esegui 'npm run update-deps' per aggiornare"
  # Non blocchiamo il push per dipendenze obsolete
fi

# 6. Controllo build di produzione
echo "ğŸ—ï¸ Test build di produzione..."
NODE_ENV=production node -e "
console.log('Testing production build...');
try {
  // Simula caricamento in produzione
  process.env.NODE_ENV = 'production';
  require('./src/utils/config');
  console.log('âœ… Build di produzione OK');
} catch (error) {
  console.error('âŒ Errore build produzione:', error.message);
  process.exit(1);
}
"

if [ $? -ne 0 ]; then
  echo "âŒ Build di produzione fallita."
  exit 1
fi

# 7. Controllo performance (memory usage)
echo "âš¡ Test performance base..."
node -e "
const startMemory = process.memoryUsage();
console.log('Memoria iniziale:', Math.round(startMemory.heapUsed / 1024 / 1024), 'MB');

// Simula caricamento moduli principali
try {
  require('./src/utils/config');
  // Altri moduli principali se esistono
  
  const endMemory = process.memoryUsage();
  const memoryIncrease = (endMemory.heapUsed - startMemory.heapUsed) / 1024 / 1024;
  
  console.log('Memoria dopo caricamento:', Math.round(endMemory.heapUsed / 1024 / 1024), 'MB');
  console.log('Incremento memoria:', Math.round(memoryIncrease), 'MB');
  
  if (memoryIncrease > 50) {
    console.error('âŒ Incremento memoria troppo alto:', Math.round(memoryIncrease), 'MB');
    process.exit(1);
  }
  
  console.log('âœ… Performance memoria OK');
} catch (error) {
  console.error('âŒ Errore test performance:', error.message);
  process.exit(1);
}
"

if [ $? -ne 0 ]; then
  echo "âŒ Test performance fallito."
  exit 1
fi

# 8. Controllo file sensibili
echo "ğŸ” Controllo file sensibili..."
if [ -f ".env" ]; then
  echo "âš ï¸ File .env trovato. Assicurati che non sia tracciato da git."
  if git ls-files --error-unmatch .env 2>/dev/null; then
    echo "âŒ File .env Ã¨ tracciato da git! Rimuovilo dal tracking."
    echo "ğŸ’¡ Esegui: git rm --cached .env"
    exit 1
  fi
fi

# 9. Controllo commit message quality (se disponibile)
echo "ğŸ“ Controllo qualitÃ  commit..."
if [ -f ".git/COMMIT_EDITMSG" ]; then
  commit_msg=$(cat .git/COMMIT_EDITMSG)
  if [ ${#commit_msg} -lt 10 ]; then
    echo "âš ï¸ Commit message molto breve. Considera di essere piÃ¹ descrittivo."
  fi
fi

# 10. Controllo branch protection
echo "ğŸŒ¿ Controllo branch..."
current_branch=$(git branch --show-current)
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âš ï¸ Stai pushando direttamente su $current_branch."
  echo "ğŸ’¡ Considera di usare feature branch e pull request per modifiche importanti."
fi

# 11. Controllo dimensione repository
echo "ğŸ“ Controllo dimensione repository..."
repo_size=$(du -sh .git 2>/dev/null | cut -f1)
if [ ! -z "$repo_size" ]; then
  echo "ğŸ“¦ Dimensione repository: $repo_size"
fi

# 12. Backup pre-push (opzionale)
echo "ğŸ’¾ Creando backup pre-push..."
backup_dir="./temp/pre-push-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$backup_dir"
cp -r src config package.json "$backup_dir/" 2>/dev/null
echo "ğŸ“ Backup creato in: $backup_dir"

echo "âœ… Tutti i controlli pre-push completati con successo!"
echo "ğŸ‰ Il codice Ã¨ pronto per il push!"
echo "ğŸ“Š Riepilogo:"
echo "   - Linting: âœ…"
echo "   - Test: âœ…"
echo "   - Coverage: âœ…"
echo "   - Sicurezza: âœ…"
echo "   - Performance: âœ…"
echo "   - Build: âœ…"
echo ""
echo "ğŸš€ Procedendo con il push..."